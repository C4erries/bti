services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - '8000:8000'
    volumes:
      - ./backend:/app
    environment:
      # AI настройки
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash}
      - CUBICASA_API_URL=http://cubicasa:8000
      - CUBICASA_TIMEOUT=${CUBICASA_TIMEOUT:-300.0}
    restart: unless-stopped
    depends_on:
      - cubicasa

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - '5173:5173'
    environment:
      # VITE_API_URL используется в браузере, поэтому указываем адрес бекенда с точки зрения хоста
      - VITE_API_URL=http://localhost:8000/api/v1
    volumes:
      - ./frontend:/app
    depends_on:
      - backend

  cubicasa:
    build:
      context: ./ai/CubiCasa-docker
      dockerfile: Dockerfile
    ports:
      - '8001:8000'
    volumes:
      - ./ai/CubiCasa-docker:/app
    environment:
      - MODEL_WEIGHTS_PATH=model_best_val_loss_var.pkl
      - DEVICE=${CUBICASA_DEVICE:-cpu}
      - PORT=8000
    restart: unless-stopped
    # Для GPU используйте:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
