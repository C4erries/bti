# Проект «Умное БТИ»

## 1. Контекст и назначение

«Умное БТИ» — цифровая платформа, которая выступает единым окном между:

- клиентами (физическими и юридическими лицами), и
- исполнителями (геодезистами, кадастровыми инженерами, техниками БТИ),

для решения задач, связанных с перепланировкой и технической инвентаризацией недвижимости.

Платформа позволяет:

- загружать план квартиры/помещения,
- описывать желаемые изменения,
- получать предварительный анализ рисков (технических, юридических, эксплуатационных),
- оформлять и сопровождать заказы на услуги БТИ (техпланы, выписки, консультации и т.д.),
- работать через личные кабинеты клиента, исполнителя и администратора.

## 2. Проблема

### Для клиентов

- Непрозрачные и сложные процедуры БТИ.
- Много шагов и визитов для получения документов.
- Высокий риск отказов из‑за ошибок в документах или незаконной перепланировки.
- Отсутствие доступной визуализации будущих изменений и понятного объяснения рисков.

### Для исполнителей

- Нестабильный поток заказов.
- Высокая административная нагрузка (координация, отчётность, коммуникация).
- Плохое качество исходных данных от клиентов (неполные или некорректные проекты перепланировки).
- Недостаток инструментов раннего выявления нарушений.

## 3. Цели проекта

- Сделать удобный и прозрачный сервис, который помогает пользователям проверить допустимость перепланировки ещё до начала ремонта.
- Снизить риски, связанные с незаконной перепланировкой (штрафы, отказ в согласовании, падение ликвидности объекта).
- Стать агрегатором для специалистов технической инвентаризации и кадастра.
- Снять часть нагрузки с БТИ и госорганов за счёт предварительной фильтрации и подготовки заявок.

## 4. Основные задачи продукта

- Личный кабинет клиента:
  - создание заказов на услуги,
  - загрузка документов (план БТИ и др.),
  - базовая визуализация и трекинг статуса заказа,
  - чат с исполнителем/AI‑ассистентом (MVP — через stub API).
- Личный кабинет исполнителя:
  - список доступных и взятых в работу заказов,
  - доступ к документам и истории статусов,
  - планирование выездов (календарь),
  - коммуникация с клиентами.
- Административная панель:
  - управление пользователями и исполнителями,
  - управление справочниками (услуги, округа, типы домов, отделы),
  - модерация заказов и назначение исполнителей,
  - базовая аналитика загрузки исполнителей.
- Интеграция AI/правил:
  - подготовка структуры данных под AI‑ассистента (чаты, анализ, правила),
  - в текущем MVP — заглушки и каркас для последующей ML/AI‑логики.

## 5. Функциональные области

### 5.1. Публичная часть

- Лэндинг с описанием:
  - основных услуг (проверка перепланировки, визуализация до/после, оформление документов, подбор исполнителей),
  - преимуществ (экономия времени и денег, прозрачность, наглядность),
  - FAQ (точность AI‑анализа, порядок работы, оплата, сроки ответа).
- Каталог услуг:
  - список услуг с описанием, ценовыми параметрами и требованиями к документам.

### 5.2. Личный кабинет клиента

- Сайдбар: проекты/заказы, история запросов.
- Мастер создания заказа:
  - выбор услуги из каталога,
  - выбор округа и типа дома из справочников (через списки, а не ввод кодов),
  - загрузка документов (техпаспорт, план БТИ и др.),
  - ввод параметров для калькулятора стоимости (площадь, виды работ, особенности),
  - город и регион в доменной модели отсутствуют: система работает в одном городе/регионе.
- Визуализация:
  - базовый 2D‑план помещения и возможность редактирования (перемещение/удаление элементов),
  - подсветка изменяемых/проблемных зон (MVP — достаточно хранить план в JSON и отдавать его на фронт; сложная редактура может быть упрощена).
- AI‑ассистент (MVP):
  - чат‑интерфейс для текстового описания изменений,
  - получение предварительного заключения (разрешено/запрещено/требует согласования) с объяснением причин и рисков.
- **Утверждение изменений плана:**
  - при получении отредактированного плана от исполнителя (статус "AWAITING_CLIENT_APPROVAL") клиент получает уведомление,
  - просмотр новой версии плана с комментарием исполнителя,
  - кнопки "Принять изменения" / "Вернуть на доработку",
  - история версий плана сохраняется и доступна для просмотра.

### 5.3. Личный кабинет исполнителя

- Панель заказов:
  - список новых/текущих/завершённых заказов с фильтрами по статусу и отделу,
  - сортировка от старых к новым.
- Страница заказа:
  - общая информация (услуга, клиент, стоимость, сложность, статус),
  - доступ к загруженным документам,
  - план и история статусов,
  - возможность взять заказ или отказаться.
  - **Редактор визуализации плана:**
    - интерактивный редактор (аналогичный клиенту) с загруженным планом клиента,
    - просмотр AI-анализа и визуализация "до/после",
    - режим редактирования с подсветкой изменений:
      - красный — удаляемые элементы,
      - зеленый — новые элементы,
      - желтый — изменяемые элементы.
  - **Действия с планом:**
    - **"Одобрить"**: Переводит статус заказа в "READY_FOR_APPROVAL" (Готов к согласованию) с финальной версией плана.
    - **"Править"**: Активирует режим редактирования — перемещение объектов, удаление/добавление зон. После правок сохраняется новая версия типа "EXECUTOR_EDITED" с комментарием исполнителя и отправляется клиенту на утверждение (статус "AWAITING_CLIENT_APPROVAL").
    - **"Отклонить"**: Смена статуса на "REJECTED_BY_EXECUTOR" (Отклонён) с обязательным комментарием и списком замечаний.
- Распределение по отделам:
  - автоматическое назначение по типу услуги,
  - ручное переназначение администратором.
- Календарь выездов:
  - события с датой, временем, местом и привязкой к заказу.

### 5.4. Административная панель

- Управление пользователями:
  - фильтрация по ролям (клиент, исполнитель),
  - просмотр и изменение ролей, блокировка, просмотр истории заказов.
- Управление исполнителями:
  - создание исполнителя (пользователь + профиль исполнителя),
  - аналитика загрузки (текущие задачи, среднее время выполнения, ошибки/отказы).
- Заказы:
  - модерация (назначение исполнителя, отправка на доработку, утверждение/отклонение),
  - изменение статуса, цены и сроков,
  - **просмотр всех версий плана по заказу** для модерации и контроля процесса согласования.
- Справочники:
  - услуги, округа, типы домов, отделы.
- Правила/подсказки для AI и журнал ошибок:
  - каркас интерфейса и моделей для управления правилами и логом ошибок (MVP — структура данных и API без полноценной AI‑логики).

## 5.5. Workflow работы с планами

### Процесс согласования плана:

1. **Клиент создает заказ и загружает план:**
   - Заказ получает статус "SUBMITTED" (Отправлен)
   - План сохраняется как версия "ORIGINAL"

2. **Исполнитель получает заказ:**
   - После назначения заказ переходит в статус "EXECUTOR_ASSIGNED" (Назначен исполнитель)
   - Исполнитель открывает редактор плана и просматривает план клиента

3. **Действия исполнителя:**
   - **Одобрить**: Заказ переходит в статус "READY_FOR_APPROVAL" (Готов к согласованию), создается финальная версия "FINAL"
   - **Править**: Исполнитель редактирует план в интерактивном редакторе:
     - Перемещение объектов, удаление/добавление зон
     - Подсветка изменений (красный — удаляемые, зеленый — новые, желтый — изменяемые)
     - Сохранение новой версии "EXECUTOR_EDITED" с комментарием
     - Заказ переходит в статус "AWAITING_CLIENT_APPROVAL" (Ожидает утверждения клиентом)
   - **Отклонить**: Заказ переходит в статус "REJECTED_BY_EXECUTOR" (Отклонён исполнителем) с комментарием и списком замечаний

4. **Клиент получает уведомление:**
   - При статусе "AWAITING_CLIENT_APPROVAL" клиент видит новую версию плана с комментарием исполнителя
   - Кнопки действий: "Принять изменения" / "Вернуть на доработку"
   - При принятии: заказ переходит в статус "READY_FOR_APPROVAL"
   - При возврате: заказ возвращается исполнителю для доработки

5. **История версий:**
   - Все версии плана сохраняются с типом (ORIGINAL, MODIFIED, EXECUTOR_EDITED, FINAL)
   - История версий доступна в разделе "История статусов" для обеих сторон
   - Админ-панель получает просмотр всех версий плана по заказу для модерации

## 6. Текущая реализация и исходные данные

На момент подключения ИИ‑агентов в репозитории уже есть:

- Backend:
  - FastAPI + SQLAlchemy + SQLite (dev),
  - доменная модель пользователей, заказов, справочников и связанных сущностей,
  - REST API, описанное в `openapi.yaml`, частично реализовано (AI‑часть пока заглушки),
  - эндпоинты работают под префиксом `/api/v1`,
  - из модели заказов убраны поля `city` и `region` (платформа привязана к одному городу/региону).
- Frontend:
  - React + Vite + Tailwind (тестовый UI),
  - базовый функционал: авторизация, простая работа с заказами.
- Docker:
  - `backend` и `frontend` поднимаются через `docker-compose`.

Важно: `openapi.yaml` не является абсолютно жёстким источником правды. Его можно и нужно корректировать при эволюции API так, чтобы он отражал фактическое состояние и не ломал реализацию.

## 7. Ограничения и допущения

- Не менять радикально стек (FastAPI, SQLAlchemy, React, Vite, Tailwind, SQLite для dev).
- На текущем этапе AI/ML‑логика и сложная визуализация могут быть реализованы в упрощённом виде (заглушки, статические конфигурации, «моки»), главное — подготовить корректный каркас данных и API.
- Больше фокус на работоспособность ключевых бизнес‑сценариев (регистрация, логин, создание/ведение заказов, взаимодействие ролей), чем на идеальный UX или дизайн.

## 8. Критерии успеха

- Пользователь (клиент) может:
  - зарегистрироваться и войти,
  - создать заказ на основе каталога услуг, выбрав округ и тип дома из списков, не вводя коды вручную,
  - видеть статусы, файлы, простую визуализацию плана и результаты предварительного анализа.
- Исполнитель может:
  - просматривать и фильтровать свои заказы,
  - брать заказы в работу и отказываться,
  - просматривать документы и план,
  - видеть календарь выездов.
- Администратор может:
  - управлять пользователями и исполнителями,
  - управлять справочниками,
  - видеть и модифицировать заказы (назначение исполнителя, статусы, цена),
  - видеть базовую аналитику и подготовленный каркас под правила/журнал ошибок.
- Backend, OpenAPI и frontend согласованы по ключевым сценариям; изменения OpenAPI допускаются, если они согласованно внедрены в код и UI.

