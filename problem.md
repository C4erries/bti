# Проект «Умное БТИ» — постановка задачи

Этот документ описывает, какую проблему решает система, какие роли и основные сценарии есть в MVP, и к какому целевому состоянию мы идём. Подробная доменная модель зафиксирована в `domain.md`.

## 1. Контекст и цель

- «Умное БТИ» — сервис для работы с перепланировками и технической документацией по квартирам/помещениям.
- Основная цель MVP:
  - упростить для клиента создание и сопровождение заказов на перепланировку/документацию;
  - поддержать исполнителей в работе с планами, выездами и статусами;
  - дать администраторам базовые инструменты управления пользователями, справочниками и аналитикой;
  - заложить фундамент для AI‑ассистента и работы с 2D/3D‑планами.

## 2. Роли и общие сценарии

- Клиент:
  - регистрируется и логинится;
  - создаёт заказы, указывая адрес, округ, тип дома и параметры работ;
  - загружает файлы (планы, документы, фото);
  - просматривает план и его версии (исходная/изменённая);
  - отслеживает статусы заказа;
  - переписывается с исполнителем и получает AI‑комментарии.

- Исполнитель:
  - видит список назначенных заказов и базовую аналитику по ним;
  - просматривает детали заказа (данные клиента, файлы, план, историю статусов);
  - работает с планом (утверждение, правки, комментарии);
  - планирует выезды в календаре.

- Администратор:
  - управляет пользователями и исполнителями;
  - управляет справочниками (округа, типы домов);
  - модерирует заказы, может менять статусы и отдел;
  - управляет правилами AI и журналом ошибок.

## 3. Архитектура на высоком уровне

- Backend:
  - FastAPI + SQLAlchemy + Pydantic (v2);
  - SQLite для dev (в перспективе — любая SQL‑СУБД);
  - JWT‑аутентификация;
  - OpenAPI‑контракт (`openapi.yaml`, `swagger.yaml`).

- Frontend:
  - React + Vite + TypeScript + Tailwind;
  - SPA с разделением по ролям (client / executor / admin);
  - конфигурируемый базовый URL API через `VITE_API_URL`.

## 4. Доменная модель (кратко)

Полное описание смотри в `domain.md`. Здесь — только ключевые акценты.

- Роли и пользователи:
  - `User` с профилями `ClientProfile` и `ExecutorProfile`;
  - статусы блокировки, отметки админа/суперадмина.

- Заказы:
  - `Order` — центральная сущность:
    - клиент, статус, заголовок, описание;
    - адрес, код округа (`districtCode`), код типа дома (`houseTypeCode`);
    - входные данные калькулятора (`calculatorInput`);
    - предварительная оценка (`estimatedPrice`) и финальная стоимость (`totalPrice`);
    - текущий отдел (`currentDepartmentCode`), история статусов и планов.

- Справочники:
  - `District` — округа города с коэффициентами цены;
  - `HouseType` — типы домов с коэффициентами;
  - отдельной сущности «услуга» (`Service`) в домене **нет**:
    - тип и сложность работ кодируются комбинацией параметров калькулятора и описанием заказа;
    - старый каталог услуг и API `/services` выводятся из эксплуатации.

- План и файлы:
  - `OrderFile` — загруженные файлы (сканы, планы, фото);
  - `OrderPlanVersion` — версии плана (ORIGINAL / MODIFIED) в формате `Plan`;
  - `Plan` — JSON‑описание 2D‑геометрии (стены, зоны, проёмы, окна, подписи) + связанный 3D‑слой (`objects3d`).
  - Контракт `Plan`/`OrderPlanVersion.plan` совпадает с `3Dmodel_schema.json`: meta (width/height/unit px + scale/background + ceiling_height_m), geometry (segment/polygon/point с openings для стен), objects3d (type + position/rotation/size с optional wallId/zoneId).

- Чат и AI:
  - `OrderChatMessage` и клиентский чат по заказу;
  - `AiAnalysis` с типами рисков (TECHNICAL, LEGAL, FINANCIAL, OPERATIONAL);
  - правила AI и журнал ошибок (минимальный CRUD, можно расширять).

## 5. Калькулятор стоимости

- Публичный калькулятор: `POST /api/v1/calc/estimate`.
- Схемы:
  - `PriceCalculatorInput` (запрос):
    - `districtCode?: string | null` — код округа;
    - `houseTypeCode?: string | null` — код типа дома;
    - `calculatorInput?: { ... } | null` — параметры работ:
      - `area?: number` — площадь;
      - `works?: { walls?: boolean; wet_zone?: boolean; doorways?: boolean }`;
      - `features?: { basement?: boolean; join_apartments?: boolean }`;
      - `urgent?: boolean`;
      - `notes?: string`.
  - `PriceEstimateResponse` (ответ):
    - `estimatedPrice: number`;
    - `breakdown: { baseComponent: number; worksComponent: number; featuresCoef: number; raw?: object | null }`.

- Принципы расчёта:
  - отдельно выделенные «услуги» в ценообразовании не используются;
  - базовая часть `baseComponent` рассчитывается из округов и типов домов (коэффициенты из справочников);
  - дополнительная часть (`worksComponent`, `featuresCoef`) зависит от параметров `calculatorInput`.

- При создании заказа:
  - клиент заполняет те же параметры, что и в публичном калькуляторе;
  - backend использует `calculatorInput` и справочники (`District`, `HouseType`) для расчёта `estimatedPrice`;
  - итоговая цена (`totalPrice`) может быть установлена/скорректирована исполнителем или администратором.

## 6. API‑контур (MVP)

Основные группы эндпоинтов (под префиксом `/api/v1`):

- Auth:
  - `POST /auth/register/client`
  - `POST /auth/login`
  - `GET /auth/me`

- Публичные справочники:
  - `GET /districts`
  - `GET /house-types`
  - `POST /calc/estimate`

- Кабинет клиента:
  - `GET /client/orders`
  - `POST /client/orders`
  - `GET /client/orders/{id}`
  - `PATCH /client/orders/{id}`
  - файлы, план, история статусов;
  - AI‑анализ: `POST /client/orders/{id}/ai/analyze`, `GET /client/orders/{id}/ai/analysis`;
  - чат: `GET /client/chats`, `GET/POST /chats/{chatId}/messages`.

- Кабинет исполнителя:
  - `GET /executor/orders`, `GET /executor/orders/{id}`;
  - план: согласование/отклонение/редактирование;
  - календарь: `GET /executor/calendar`, создание/изменение событий.

- Админка:
  - `GET/POST/PATCH /admin/districts`
  - `GET/POST/PATCH /admin/house-types`
  - `GET/POST/PATCH /admin/users`, `/admin/executors`
  - `GET/POST/PATCH /admin/orders`
  - правила AI и журнал ошибок (минимальный CRUD).

## 7. Эволюция домена

- Ранее в системе была сущность `Service` (справочник услуг) и связанные API `/services`, `/admin/services`, а также поля `serviceCode`/`serviceTitle` в заказах.
- Новая доменная модель отказывается от отдельного справочника услуг:
  - тип работ задаётся через параметры калькулятора и текст заказа;
  - все поля и эндпоинты, связанные с `Service`, должны быть последовательно выведены из кода, схем БД, OpenAPI и фронтенда;
  - ??? ?????????? dev-?? ????? ???????? `services`/`service_code` ????? ??????????? ??????? ?? ????? `schema.sql` ??? ?????? ????????? `init_data.py`.
  - миграционный план описан на уровне кода в отдельном промпте для агента (см. задачу по рефакторингу).

На момент принятия этого документа код ещё может содержать упоминания `Service` — это считается техническим долгом и должно быть устранено в рамках отдельной задачи по рефакторингу.

